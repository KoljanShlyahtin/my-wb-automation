/**
 * === –°–ö–†–ò–ü–¢ –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ì–õ–ê–í–ù–´–ú –°–í–ï–¢–û–ú (–ú–ê–°–¢–ï–†-–ö–õ–ê–í–ò–®–ê "–£–•–û–î") ===
 * –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:
 * - –î–õ–ò–ù–ù–û–ï –Ω–∞–∂–∞—Ç–∏–µ ("–£—Ö–æ–¥"): 
 *   - –í—ã–∫–ª—é—á–∞–µ—Ç –í–ï–°–¨ —Å–≤–µ—Ç –≤ –∫–≤–∞—Ä—Ç–∏—Ä–µ, –∫—Ä–æ–º–µ –ø–æ–¥—Å–≤–µ—Ç–æ–∫ (—Ç—É–∞–ª–µ—Ç, –∑–∞–ª).
 *   - –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ.
 * - –ö–û–†–û–¢–ö–û–ï –Ω–∞–∂–∞—Ç–∏–µ: –í–∫–ª—é—á–∞–µ—Ç/–≤—ã–∫–ª—é—á–∞–µ—Ç –±—Ä–∞ –Ω–∞ —Å—Ç–µ–Ω–µ –∫–æ—Ä–∏–¥–æ—Ä–∞ (wb-mr6cv3_235/K2).
 * - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∑–≤—É–∫–æ–≤—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–∏ "—É—Ö–æ–¥–µ" (off.wav).
 */

// === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===
// –°–ø–∏—Å–æ–∫ –í–°–ï–ì–û —Å–≤–µ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –≤—ã–∫–ª—é—á–∞—Ç—å –ø—Ä–∏ "—É—Ö–æ–¥–µ"
// (–≤–∫–ª—é—á–∞—è –±—Ä–∞, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–æ —á–∞—Å—Ç—å –æ–±—â–µ–≥–æ –æ—Å–≤–µ—â–µ–Ω–∏—è)
var ALL_LIGHTS_TO_OFF = [
    "wb-led_56/CCT1",
    "wb-led_56/CCT2",
    "wb-mr6cv3_235/K2", // <-- –í–ï–†–ù–£–¢–û! –ë—Ä–∞ –≤—ã–∫–ª—é—á–∞–µ—Ç—Å—è –ø—Ä–∏ "—É—Ö–æ–¥–µ".
    "wb-mr6cv3_235/K3",
    "wb-mr6cv3_235/K4",
    "wb-mr6cv3_235/K5",
    "wb-mr6cv3_235/K6",
    "wb-led_145/Channel 1",
    "wb-mr6c_38/K1",
    "wb-mr6c_38/K2",
    "wb-mr6c_38/K3",
    // "wb-led_145/Channel 3", // <-- –ò–°–ö–õ–Æ–ß–ï–ù–û! –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∑–∞–ª–∞.
    // "wb-led_145/Channel 4", // <-- –ò–°–ö–õ–Æ–ß–ï–ù–û! –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∑–∞–ª–∞.
    "wb-mr6c_117/K1",
    "wb-mr6c_117/K4",
    // "wb-led_145/Channel 2", // <-- –ò–°–ö–õ–Æ–ß–ï–ù–û! –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç—É–∞–ª–µ—Ç–∞.
    "wb-mr6c_117/K2",
    "wb-mr6c_38/K5",
    "wb-mr6c_38/K6",
    "wb-mr6c_117/K5",
    "wb-mr6c_117/K6",
    "wb-led_53/Channel 3",
    "wb-led_53/Channel 4"
];

// –°–ø–∏—Å–æ–∫ –ø–æ–¥—Å–≤–µ—Ç–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï —Ç—Ä–æ–≥–∞—Ç—å (–æ—Å—Ç–∞–≤–ª—è—Ç—å –∫–∞–∫ –µ—Å—Ç—å)
var BACKLIGHTS_TO_KEEP = {
    "wb-led_145/Channel 2": "wb-led_145/Channel 2 Brightness", // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç—É–∞–ª–µ—Ç–∞
    "wb-led_145/Channel 3": "wb-led_145/Channel 3 Brightness", // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∑–∞–ª–∞ 1
    "wb-led_145/Channel 4": "wb-led_145/Channel 4 Brightness"  // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∑–∞–ª–∞ 2
};

var NIGHT_MODE_CONFIG = {
    DEFAULT_BRIGHTNESS: 2
};

// === –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–∞ —á–µ—Ä–µ–∑ aplay ===
function playSound(soundFile) {
    var command = "aplay -q -D hw:1 \"" + soundFile + "\"";
    log("‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ: {}", soundFile);
    runShellCommand(command, {
        captureOutput: true,
        exitCallback: function(exitCode, output) {
            if (exitCode !== 0) {
                log("‚ùå –û—à–∏–±–∫–∞ aplay (–∫–æ–¥ {}): {}", exitCode, output.trim());
            }
        }
    });
}
function soundOff() { playSound("/home/off.wav"); }

// === –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è "–£—Ö–æ–¥" ===
function masterSwitchOff() {
    log("üö™ –ö–æ–º–∞–Ω–¥–∞ \"–£—Ö–æ–¥\": –≤—ã–∫–ª—é—á–∞—é –≤–µ—Å—å —Å–≤–µ—Ç, –∫—Ä–æ–º–µ –ø–æ–¥—Å–≤–µ—Ç–æ–∫ (—Ç—É–∞–ª–µ—Ç, –∑–∞–ª).");

    // –í—ã–∫–ª—é—á–∞–µ–º –≤—Å—ë –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ (—Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞—è –±—Ä–∞)
    for (var i = 0; i < ALL_LIGHTS_TO_OFF.length; i++) {
        var id = ALL_LIGHTS_TO_OFF[i];
        dev[id] = false;
    }

    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –í–°–ï –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
    for (var id in BACKLIGHTS_TO_KEEP) {
        if (dev[id] !== undefined) {
            dev[id] = true;
            var brightnessId = BACKLIGHTS_TO_KEEP[id];
            if (dev[brightnessId] !== undefined) {
                dev[brightnessId] = NIGHT_MODE_CONFIG.DEFAULT_BRIGHTNESS;
            }
        }
    }

    soundOff();
    log("‚úÖ \"–£—Ö–æ–¥\" –≤—ã–ø–æ–ª–Ω–µ–Ω. –í—Å—è –∫–≤–∞—Ä—Ç–∏—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞, –∫—Ä–æ–º–µ –ø–æ–¥—Å–≤–µ—Ç–æ–∫.");
}

// === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–æ–π –≤ –∫–æ—Ä–∏–¥–æ—Ä–µ ===
// –ö–û–†–û–¢–ö–û–ï –Ω–∞–∂–∞—Ç–∏–µ - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–∞
defineRule({
    whenChanged: "wb-mr6cv3_235/Input 2 Single Press Counter",
    then: function() {
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±—Ä–∞
        dev["wb-mr6cv3_235/K2"] = !dev["wb-mr6cv3_235/K2"];
        log("üí° –ë—Ä–∞ –Ω–∞ —Å—Ç–µ–Ω–µ: {}", dev["wb-mr6cv3_235/K2"] ? "–í–ö–õ" : "–í–´–ö–õ");
    }
});

// –î–õ–ò–ù–ù–û–ï –Ω–∞–∂–∞—Ç–∏–µ - "–£—Ö–æ–¥"
defineRule({
    whenChanged: "wb-mr6cv3_235/Input 2 Long Press Counter",
    then: function() {
        masterSwitchOff();
    }
});
